<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width">

  <link rel="canonical" href="https://alexn.org/blog/2017/01/13/traversable.html">
  <link rel="alternate" href="/atom.xml" title="Atom feed" type="application/atom+xml">

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@alexelcu" />

    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2017-01-13" />
    
    <meta property="article:tag" content="Functional" />
    <meta property="article:tag" content="Code" />
    <meta property="article:tag" content="Scala" />

    <title>Why scala.collection.Traversable Is Bad Design</title>
    <meta name="og:title" content="Why scala.collection.Traversable Is Bad Design" />
    <meta name="twitter:title" content="Why scala.collection.Traversable Is Bad Design" />

      <meta name="og:image" content="https://alexn.org/assets/img/2017/scala-icon.png" />
      <meta name="og:image:secure_url" content="https://alexn.org/assets/img/2017/scala-icon.png" />
      <meta name="twitter:image" content="https://alexn.org/assets/img/2017/scala-icon.png" />

      <meta name="og:description" content="Traversable was a design mistake, is redundant and we should remove it" />
      <meta name="twitter:description" content="Traversable was a design mistake, is redundant and we should remove it" />
      <meta name="description" content="Traversable was a design mistake, is redundant and we should remove it" />

  <link href="/assets/css/fonts-8b37e535.css" rel="stylesheet" />
  <link href="/assets/css/all-3b6fe599.css" rel="stylesheet" />
  <!--[if lt IE 9]>
  <link href="/assets/css/ie-hacks-0c76b2ed.css" rel="stylesheet" />
  <![endif]-->
</head>
<body>
  <div id="header-container">
    <header>
      <h1 id="title">alexn.org</h1>

      <meta itemprop="lastReviewed" content="2019-01-03"/>
      <div itemprop="reviewedBy" itemscope itemtype="https://schema.org/Person">
        <meta itemprop="name" content="Alexandru Nedelcu">
        <meta itemprop="url" content="https://alexn.org/about.html">
      </div>

      <div class="github-fork-ribbon-wrapper right">
        <div class="github-fork-ribbon">
          <a href="https://github.com/alexandru" itemprop="relatedLink">Fork me on GitHub</a>
        </div>
      </div>

      <nav>
    	  <a href="/">alexn.org</a>
    	  <a class="extra" href="/about.html" itemprop="significantLink">About</a>
      </nav>
    </header>
  </div>

  <div id="main-container">
    <div id="main">
      <article id="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <h1 itemprop="headline">Why scala.collection.Traversable Is Bad Design</h1>

    <div id="meta">
      <meta itemscope itemprop="mainEntityOfPage"  itemType="https://schema.org/WebPage" itemid="https://alexn.org/blog/2017/01/13/traversable.html"/>
      <meta itemprop="datePublished" content="2017-01-13"/>
      <meta itemprop="dateModified" content="2017-01-13"/>

      <time class="post-date" itemprop="dateCreated" datetime="2017-01-13">
        Jan 13, 2017
      </time>

      <span class="twitter-link">
        â€¢ <a href="https://twitter.com/alexelcu">@alexelcu</a>
      </span>

        <div itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
          <meta itemprop="url" content="https://alexn.org/assets/img/2017/scala-icon.png">
          <meta itemprop="width" content="680">
          <meta itemprop="height" content="680">
        </div>

      <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <meta itemprop="name" content="Alexandru Nedelcu">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
          <meta itemprop="url" content="https://alexn.org/assets/img/alex-big-version-72ppi.jpg">
          <meta itemprop="width" content="585">
          <meta itemprop="height" content="585">
        </div>
      </div>
    </div>
  </header>

  <div id="content" itemprop="articleBody">
    <p><img src="/assets/img/2017/scala-icon.png" class="right" width="200" alt="Scala icon" /></p>

<p>Given there's a
<a href="https://contributors.scala-lang.org/t/ongoing-work-on-standard-collections-redesign/293">Scala collection redesign</a>
discussion going on, it's a good time to talk about one of my personal pet peeves:
the existence of <a href="http://www.scala-lang.org/api/2.12.1/scala/collection/Traversable.html">Traversable</a>
in the standard library, along with its variants like <code class="highlighter-rouge">TraversableLike</code> and <code class="highlighter-rouge">TraversableOnce</code>.
Apparently this interface is missing in the new design and that's awesome.</p>

<p>It's easy to make API mistakes, we all do it and it's important to
learn from past mistakes, this document serving as a lesson for why
<code class="highlighter-rouge">Traversable</code> is a bad idea.</p>

<p>Claims:</p>

<ol>
  <li><code class="highlighter-rouge">Traversable</code> has implicit behavior assumptions that are not visible
in its exposed signature, the API being error prone</li>
  <li>Iterating over a <code class="highlighter-rouge">Traversable</code> has worse performance than <code class="highlighter-rouge">Iterator</code></li>
  <li>There exists no <code class="highlighter-rouge">Traversable</code> data type that doesn't admit an efficient
<code class="highlighter-rouge">Iterator</code> implementation, thus <code class="highlighter-rouge">Traversable</code> being completely redundant</li>
</ol>

<p>As a reminder and you can also
<a href="http://docs.scala-lang.org/overviews/collections/trait-traversable.html">read the docs</a>,
the <code class="highlighter-rouge">Traversable</code> is a trait like the following:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">trait</span> <span class="nc">Traversable</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">foreach</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
<span class="o">}</span>
</code></pre></div>
<p>The standard library also has the venerable <code class="highlighter-rouge">Iterable</code> / <code class="highlighter-rouge">Iterator</code>:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">trait</span> <span class="nc">Iterable</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">iterator</span><span class="o">()</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">Iterator</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">hasNext</span><span class="k">:</span> <span class="kt">Boolean</span>
  <span class="k">def</span> <span class="n">next</span><span class="o">()</span><span class="k">:</span> <span class="kt">A</span>
<span class="o">}</span>
</code></pre></div>
<p>Can you spot the similarities?</p>

<p>You should, because these 2 interfaces are supposed to be
<a href="https://en.wikipedia.org/wiki/Duality_(mathematics)">duals</a>.
So if you think of <code class="highlighter-rouge">Traversable</code> as being defined by that
<code class="highlighter-rouge">foreach</code> function, then <code class="highlighter-rouge">Iterable</code> is that function with
its arrows reversed:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">type</span> <span class="kt">Traversable</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span><span class="n">A</span> <span class="k">=&gt;</span> <span class="o">())</span> <span class="k">=&gt;</span> <span class="o">()</span>

<span class="k">type</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">A</span><span class="o">)</span>
</code></pre></div>
<p>Now this is interesting. For one <code class="highlighter-rouge">Traversable</code> is a sort of
inversion of control technique, so instead of having a cursor
that you have to manually advance, you now register a callback to
a function and that callback gets called for you on each element.
This actually frees us from certain <code class="highlighter-rouge">Iterator</code> constraints.
For example with a push-based API we should no longer care when
those function calls happen.</p>

<p>But you should already spot problems with the above
definition. Our <code class="highlighter-rouge">Iterable</code> function signature isn't complete,
this one is:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">type</span> <span class="kt">Iterable</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="k">=</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>

<span class="k">type</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="k">=</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">Try</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span>
</code></pre></div>
<p>Or in other words any <code class="highlighter-rouge">Iterator</code> can:</p>

<ol>
  <li>give us the next element,</li>
  <li>or signal completion or failure</li>
</ol>

<p>This means that the actual dual of <code class="highlighter-rouge">Iterator</code> is:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">type</span> <span class="kt">Observer</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Try</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=&gt;</span> <span class="nc">Unit</span>
</code></pre></div>
<p>Or for those OOP-oriented among us, I give you the <code class="highlighter-rouge">Observer</code>
as championed by <a href="https://github.com/Reactive-Extensions/Rx.NET">Rx.NET</a>,
as the true dual of <code class="highlighter-rouge">Iterator</code>:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">trait</span> <span class="nc">Observer</span><span class="o">[</span><span class="kt">-A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">onNext</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">onComplete</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">onError</span><span class="o">(</span><span class="n">ex</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
<span class="o">}</span>
</code></pre></div>
<p>(Hello <strong><a href="https://monix.io/">Monix</a></strong> :-))</p>

<p>This matters because <code class="highlighter-rouge">Traversable</code> has <strong>no way to signal completion or failure</strong>,
unless you get a guarantee that all the processing happens synchronously, everything
being over after the invocation of its <code class="highlighter-rouge">foreach</code>.</p>

<p>As an abstraction, this makes it useless when compared with <code class="highlighter-rouge">Iterable</code>
and <code class="highlighter-rouge">Iterator</code>. If you introduce the synchronous execution constraint,
there exists no data type that can implement <code class="highlighter-rouge">Traversable</code> and that doesn't
admit an <code class="highlighter-rouge">Iterator</code> implementation. None.</p>

<p>Even more problematic in my opinion is that this restriction isn't
visible in its API, unless your eyes are trained for it. With
<code class="highlighter-rouge">Iterator.next()</code> whether you want it or not, you have to process things
synchronously, because <em>the signature says so</em>.</p>

<p>Also problematic is <code class="highlighter-rouge">TraversableOnce</code>, which is supposed to be a
traversable that can only be traversed once, like its name says.
We've got this:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">trait</span> <span class="nc">TraversableOnce</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">foreach</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">Traversable</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">TraversableOnce</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</code></pre></div>
<p>Besides the name and the inheritance relationship, there is no difference.
This is another problem. Even if the API is effectful/impure, we should still
be able to use types serving as documentation. Contrast with the
<code class="highlighter-rouge">Iterable</code> / <code class="highlighter-rouge">Iterator</code> separation. Iterating over an <code class="highlighter-rouge">Iterator</code> is known to
consume it and you can see this in its API. And the generator/factory part is in
<code class="highlighter-rouge">Iterable</code>, which is good separation of concerns.</p>

<p><code class="highlighter-rouge">Traversable</code> also has worse performance than <code class="highlighter-rouge">Iterator</code>.
The ugly truth is that the JVM hasn't been doing a good job at
inlining that function reference you pass to <code class="highlighter-rouge">foreach</code>. This is called
<a href="http://www.azulsystems.com/blog/cliff/2011-04-04-fixing-the-inlining-problem">the inlining problem</a>,
which happens for megamorphic function calls in hot inner loops.</p>

<p>So there you have it and I hope that along with the redesign we'll get rid
of <code class="highlighter-rouge">Traversable</code>.</p>

<p class="extra-info">
My opinions have been highly influenced by the work of Erik Meijer,
if you want to learn more checkout this presentation:

<a href="https://vimeo.com/98922027">Contravariance is the Dual of Covariance Implies Iterable is the Dual of Observable</a>.
</p>


    <div class="authorship" itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alexandru Nedelcu">
      Written by <a href="https://alexn.org/about.html" itemprop="url" rel="author">
        Alexandru Nedelcu</a> |
      <a href="https://twitter.com/alexelcu" itemprop="url" rel="author">
        Twitter</a> |
      <a href="https://github.com/alexandru" itemprop="url" rel="author">
        GitHub</a>
    </div>
  </div>

  <footer>
    <div id="other-articles">
      <h2>Recent Articles</h2>

      <ul class="posts">
      	<li>
      	  <time datetime="2018-05-06">
      	    2018-05-06 &raquo;
      	  </time>
      	  <a href="/blog/2018/05/06/bifunctor-io.html" rel="prefetch related">On Bifunctor IO and Java's Checked Exceptions</a>
      	</li>
      	<li>
      	  <time datetime="2018-02-12">
      	    2018-02-12 &raquo;
      	  </time>
      	  <a href="/blog/2018/02/12/in-defense-oofp.html" rel="prefetch related">In Defense of OOFP</a>
      	</li>
      	<li>
      	  <time datetime="2017-11-10">
      	    2017-11-10 &raquo;
      	  </time>
      	  <a href="/blog/2017/11/10/minitest-no-crap-scala-library.html" rel="prefetch related">Minitest: Zero Crap Scala Testing Library</a>
      	</li>
      	<li>
      	  <time datetime="2017-10-15">
      	    2017-10-15 &raquo;
      	  </time>
      	  <a href="/blog/2017/10/15/functional-programming.html" rel="prefetch related">What is Functional Programming?</a>
      	</li>
      	<li>
      	  <time datetime="2017-10-13">
      	    2017-10-13 &raquo;
      	  </time>
      	  <a href="/blog/2017/10/13/scaladays-copenhagen.html" rel="prefetch related">Scala Days 2017 â€” Monix Task</a>
      	</li>
      	<li>
      	  <time datetime="2017-10-11">
      	    2017-10-11 &raquo;
      	  </time>
      	  <a href="/blog/2017/10/11/javascript-promise-leaks-memory.html" rel="prefetch related">JavaScript's Promise Leaks Memory</a>
      	</li>
      	<li>
      	  <time datetime="2017-08-16">
      	    2017-08-16 &raquo;
      	  </time>
      	  <a href="/blog/2017/08/16/automatic-releases-sbt-travis.html" rel="prefetch related">Automatic Releases to Maven Central with Travis and SBT</a>
      	</li>
      </ul>
    </div>

    <div id="contributions">
      <script data-isso="/comments/alexn/"
              data-isso-css="true"
              data-isso-lang="en"
              data-isso-reply-to-self="true"
              data-isso-require-author="true"
              data-isso-require-email="false"
              data-isso-reply-notifications="true"
              data-isso-max-comments-top="10"
              data-isso-max-comments-nested="5"
              data-isso-reveal-on-click="5"
              data-isso-gravatar="true"
              data-isso-avatar="false"
              data-isso-vote="true"
              data-vote-levels=""
              src="https://alexn.org/comments/alexn/js/embed.min.js"></script>
      <section id="isso-thread" data-title="{{ page.title }}">
      </section>
    </div>
  </footer>
</article>

    </div>
  </div>

  <div id="footer-container">
    <footer>
      <div class="contact">
      	&copy; 2019 Alexandru Nedelcu
      	<br>
      	Some rights reserved (<a href="http://creativecommons.org/licenses/by-nc/3.0/" rel="license">CC BY-NC 3.0</a>)
      </div>

      <div class="rss">
      	<a href="https://twitter.com/alexelcu" target="_blank" title="Follow me on Twitter (@alexelcu)">
      	  <img src="/assets/img/twitter-logo.png" width="60" height="60" alt="Follow me on Twitter (@alexelcu)" />
      	</a>
      </div>
    </footer>
  </div>

  <!-- Matomo -->
  <script type="text/javascript">
    var _paq = _paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="https://oriel.matomo.cloud/";
      _paq.push(['setTrackerUrl', u+'piwik.php']);
      _paq.push(['setSiteId', '2']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.type='text/javascript'; g.async=true; g.defer=true; g.src='//cdn.matomo.cloud/oriel.matomo.cloud/piwik.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <noscript><p><img src="https://oriel.matomo.cloud/piwik.php?idsite=2&amp;rec=1" style="border:0;" alt="" /></p></noscript>
  <!-- End Matomo Code -->
</body>
</html>
