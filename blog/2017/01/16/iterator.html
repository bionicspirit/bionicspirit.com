<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width">

  <link rel="canonical" href="https://alexn.org/blog/2017/01/16/iterator.html">
  <link rel="alternate" href="/atom.xml" title="Atom feed" type="application/atom+xml">

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@alexelcu" />

    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2017-01-16" />
    
    <meta property="article:tag" content="Functional" />
    <meta property="article:tag" content="Code" />
    <meta property="article:tag" content="Scala" />

    <title>Fixing scala.collection.Iterator</title>
    <meta name="og:title" content="Fixing scala.collection.Iterator" />
    <meta name="twitter:title" content="Fixing scala.collection.Iterator" />

      <meta name="og:image" content="https://alexn.org/assets/img/2017/scala-icon.png" />
      <meta name="og:image:secure_url" content="https://alexn.org/assets/img/2017/scala-icon.png" />
      <meta name="twitter:image" content="https://alexn.org/assets/img/2017/scala-icon.png" />

      <meta name="og:description" content="The venerable Iterator interface we all love and hate could use some improvements" />
      <meta name="twitter:description" content="The venerable Iterator interface we all love and hate could use some improvements" />
      <meta name="description" content="The venerable Iterator interface we all love and hate could use some improvements" />

  <link href="/assets/css/fonts-8b37e535.css" rel="stylesheet" />
  <link href="/assets/css/all-b9d1ad87.css" rel="stylesheet" />
  <!--[if lt IE 9]>
  <link href="/assets/css/ie-hacks-0c76b2ed.css" rel="stylesheet" />
  <![endif]-->

  <!-- Google authorship -->
  <link href="https://plus.google.com/+alexelcu" rel="publisher">
</head>
<body>
  <div id="header-container">
    <header>
      <h1 id="title">alexn.org</h1>

      <meta itemprop="lastReviewed" content="2018-07-31"/>
      <div itemprop="reviewedBy" itemscope itemtype="https://schema.org/Person">
        <meta itemprop="name" content="Alexandru Nedelcu">
        <meta itemprop="url" content="https://plus.google.com/+alexelcu">
      </div>

      <div class="github-fork-ribbon-wrapper right">
        <div class="github-fork-ribbon">
          <a href="https://github.com/alexandru" itemprop="relatedLink">Fork me on GitHub</a>
        </div>
      </div>

      <nav>
    	  <a href="/">alexn.org</a>
    	  <a class="extra" href="/about.html" itemprop="significantLink">About</a>
      </nav>
    </header>
  </div>

  <div id="main-container">
    <div id="main">
      <article id="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <h1 itemprop="headline">Fixing scala.collection.Iterator</h1>

    <div id="meta">
      <meta itemscope itemprop="mainEntityOfPage"  itemType="https://schema.org/WebPage" itemid="https://alexn.org/blog/2017/01/16/iterator.html"/>
      <meta itemprop="datePublished" content="2017-01-16"/>
      <meta itemprop="dateModified" content="2017-01-16"/>

      <time class="post-date" itemprop="dateCreated" datetime="2017-01-16">
        Jan 16, 2017
      </time>

      <span class="twitter-link">
        • <a href="https://twitter.com/alexelcu">@alexelcu</a>
      </span>

        <div itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
          <meta itemprop="url" content="https://alexn.org/assets/img/2017/scala-icon.png">
          <meta itemprop="width" content="680">
          <meta itemprop="height" content="680">
        </div>

      <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <meta itemprop="name" content="Alexandru Nedelcu">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
          <meta itemprop="url" content="https://alexn.org/assets/img/alex-big-version-72ppi.jpg">
          <meta itemprop="width" content="585">
          <meta itemprop="height" content="585">
        </div>
      </div>
    </div>
  </header>

  <div id="content" itemprop="articleBody">
    <p><img src="/assets/img/2017/scala-icon.png" class="right" width="100" alt="Scala icon" /></p>

<p>In my previous article I talked about
<a href="/blog/2017/01/13/traversable.html">getting rid of Traversable</a> because the
<code class="highlighter-rouge">Iterable</code> and <code class="highlighter-rouge">Iterator</code> duo is enough for Scala's standard library.
But the <code class="highlighter-rouge">Iterator</code> interface can also use some improvements.</p>

<p>As a reminder, the <code class="highlighter-rouge">Iterator</code> interface is something like this:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">trait</span> <span class="nc">Iterator</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">hasNext</span><span class="k">:</span> <span class="kt">Boolean</span>
  <span class="k">def</span> <span class="n">next</span><span class="o">()</span><span class="k">:</span> <span class="kt">A</span>
<span class="o">}</span>
</code></pre></div>
<p>It's a destructive interface that is consumed for as long as you call <code class="highlighter-rouge">next()</code>,
it obviously has "identity" and you're supposed to use it like this:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">val</span> <span class="n">cursor</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="k">var</span> <span class="n">sum</span> <span class="k">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">hasNext</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">sum</span> <span class="o">+=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">next</span><span class="o">()</span>
<span class="o">}</span>
</code></pre></div>
<h2 id="problem-1-both-methods-hasnext-next-are-side-effecting">Problem 1: Both methods (hasNext, next) are side-effecting</h2>

<p>You could say that <code class="highlighter-rouge">hasNext</code> is not supposed to move the internal
cursor / pointer / index and thus it shouldn't be side-effecting, but
that's not true, because in many cases the only way to know if there
is a next element to be served is to trigger a side-effecting read.</p>

<p>And so the problem is that both <code class="highlighter-rouge">hasNext</code> and <code class="highlighter-rouge">next()</code> are side-effecting and
in my opinion the result of the wrong method is getting cached. When you work with
Functional Programming for a while, you start noticing when APIs have their
side-effects screwed ;-)</p>

<p>We can't really blame Scala though. This interface has been imported from
Java and kept similar probably for remaining familiar.</p>

<p>But let me illustrate by building an iterator for reading an <code class="highlighter-rouge">InputStream</code>:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">class</span> <span class="nc">IteratorFromStream</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">InputStream</span><span class="o">,</span> <span class="n">chunkSize</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
  <span class="k">extends</span> <span class="nc">Iterator</span><span class="o">[</span><span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]]</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">buffer</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="n">chunkSize</span><span class="o">)</span>
  <span class="k">private</span> <span class="k">var</span> <span class="n">chunk</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]</span> <span class="k">=</span> <span class="k">_</span>
  <span class="k">private</span> <span class="k">var</span> <span class="n">hasChunk</span> <span class="k">=</span> <span class="kc">false</span>

  <span class="k">def</span> <span class="n">hasNext</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">hasChunk</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">len</span> <span class="k">=</span> <span class="n">in</span><span class="o">.</span><span class="n">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">chunk</span> <span class="k">=</span> <span class="n">util</span><span class="o">.</span><span class="nc">Arrays</span><span class="o">.</span><span class="n">copyOf</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">len</span><span class="o">)</span>
        <span class="n">hasChunk</span> <span class="k">=</span> <span class="kc">true</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">in</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">hasChunk</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">next</span><span class="o">()</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hasNext</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">ref</span> <span class="k">=</span> <span class="n">chunk</span>
      <span class="n">chunk</span> <span class="k">=</span> <span class="kc">null</span> <span class="c1">// GC purposes
</span>      <span class="n">hasChunk</span> <span class="k">=</span> <span class="kc">false</span>
      <span class="n">ref</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">NoSuchElementException</span><span class="o">(</span><span class="s">"InputStream is empty"</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Not that particularly exciting and you can see how <code class="highlighter-rouge">next()</code> has to duplicate
the work of <code class="highlighter-rouge">hasNext</code> and that <code class="highlighter-rouge">hasNext</code> itself is side-effecting, because
we have to read from the <code class="highlighter-rouge">InputStream</code> before being able to answer that question.</p>

<p>We can do better and we don't have to be original about it.
Behold the alternative inspired by
<a href="https://msdn.microsoft.com/en-us/library/system.collections.ienumerator(v=vs.110).aspx">IEnumerator from C#</a>:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">trait</span> <span class="nc">Iterator</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="o">{</span>
  <span class="c1">// Side-effecting, moves the cursor
</span>  <span class="k">def</span> <span class="n">moveNext</span><span class="o">()</span><span class="k">:</span> <span class="kt">Boolean</span>

  <span class="c1">// Not side-effecting, can be called multiple times
</span>  <span class="k">def</span> <span class="n">current</span><span class="k">:</span> <span class="kt">A</span>
<span class="o">}</span>
</code></pre></div>
<p>Usage is straightforward:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">val</span> <span class="n">cursor</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="k">var</span> <span class="n">sum</span> <span class="k">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">moveNext</span><span class="o">())</span> <span class="o">{</span>
  <span class="n">sum</span> <span class="o">+=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">current</span>
<span class="o">}</span>
</code></pre></div>
<p>This interface feels more natural to developers because "moving" the
cursor is the side-effect, not reading the current value.
And here's how the above implementation changes:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">class</span> <span class="nc">IteratorFromStream</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">InputStream</span><span class="o">,</span> <span class="n">chunkSize</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
  <span class="k">extends</span> <span class="nc">Iterator</span><span class="o">[</span><span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]]</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">buffer</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="n">chunkSize</span><span class="o">)</span>
  <span class="k">private</span> <span class="k">var</span> <span class="n">chunk</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]</span> <span class="k">=</span> <span class="k">_</span>

  <span class="k">def</span> <span class="n">moveNext</span><span class="o">()</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">len</span> <span class="k">=</span> <span class="n">in</span><span class="o">.</span><span class="n">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">chunk</span> <span class="k">=</span> <span class="n">util</span><span class="o">.</span><span class="nc">Arrays</span><span class="o">.</span><span class="n">copyOf</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">len</span><span class="o">)</span>
      <span class="kc">true</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
      <span class="n">chunk</span> <span class="k">=</span> <span class="kc">null</span>
      <span class="n">in</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
      <span class="kc">false</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">current</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">chunk</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="nc">NoSuchElementException</span><span class="o">(</span><span class="s">"current"</span><span class="o">)</span>
    <span class="n">chunk</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Notice how this <em>simplifies</em> things on the implementation side as well.</p>

<p><strong>UPDATE:</strong> M.Odersky points out in the comments that the standard library has a
<a href="http://www.scala-lang.org/api/current/scala/collection/BufferedIterator.html">BufferedIterator</a>
implementation that caches the current <code class="highlighter-rouge">head</code> and can be used for convenience.</p>

<h2 id="problem-2-iterator-comes-with-operations-attached">Problem 2: Iterator comes with operations attached</h2>

<p>At the beginning I gave you a simplified <code class="highlighter-rouge">Iterator</code> definition, however I lied.
The true <code class="highlighter-rouge">scala.collection.Iterator</code> is closer to this:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">package</span> <span class="nn">scala.collection</span>

<span class="k">trait</span> <span class="nc">Iterator</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">TraversableOnce</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">hasNext</span><span class="k">:</span> <span class="kt">Boolean</span>
  <span class="k">def</span> <span class="n">next</span><span class="o">()</span><span class="k">:</span> <span class="kt">A</span>

  <span class="k">def</span> <span class="n">isTraversableAgain</span> <span class="k">=</span> <span class="kc">false</span>
  <span class="k">def</span> <span class="n">isEmpty</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">!</span><span class="n">hasNext</span>
  <span class="k">def</span> <span class="n">hasDefiniteSize</span> <span class="k">=</span> <span class="n">isEmpty</span>

  <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">take</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">slice</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">drop</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">slice</span><span class="o">(</span><span class="n">from</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">until</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="o">++[</span><span class="kt">B</span> <span class="k">&gt;:</span> <span class="kt">A</span><span class="o">](</span><span class="n">that</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">GenTraversableOnce</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">flatMap</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">GenTraversableOnce</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">filter</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">corresponds</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">that</span><span class="k">:</span> <span class="kt">GenTraversableOnce</span><span class="o">[</span><span class="kt">B</span><span class="o">])(</span><span class="n">p</span><span class="k">:</span> <span class="o">(</span><span class="kt">A</span><span class="o">,</span> <span class="kt">B</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">withFilter</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">filterNot</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">collect</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">pf</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">scanLeft</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">z</span><span class="k">:</span> <span class="kt">B</span><span class="o">)(</span><span class="n">op</span><span class="k">:</span> <span class="o">(</span><span class="kt">B</span><span class="o">,</span> <span class="kt">A</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">scanRight</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">z</span><span class="k">:</span> <span class="kt">B</span><span class="o">)(</span><span class="n">op</span><span class="k">:</span> <span class="o">(</span><span class="kt">A</span><span class="o">,</span> <span class="kt">B</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">takeWhile</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">partition</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="nc">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">span</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="nc">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">dropWhile</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">zip</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">that</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[(</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">)]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">padTo</span><span class="o">[</span><span class="kt">A1</span> <span class="k">&gt;:</span> <span class="kt">A</span><span class="o">](</span><span class="n">len</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">elem</span><span class="k">:</span> <span class="kt">A1</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A1</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">zipWithIndex</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[(</span><span class="kt">A</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">foreach</span><span class="o">[</span><span class="kt">U</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">U</span><span class="o">)</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">forall</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">exists</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">contains</span><span class="o">(</span><span class="n">elem</span><span class="k">:</span> <span class="kt">Any</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">indexWhere</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">indexOf</span><span class="o">[</span><span class="kt">B</span> <span class="k">&gt;:</span> <span class="kt">A</span><span class="o">](</span><span class="n">elem</span><span class="k">:</span> <span class="kt">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">buffered</span><span class="k">:</span> <span class="kt">BufferedIterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">grouped</span><span class="o">[</span><span class="kt">B</span> <span class="k">&gt;:</span> <span class="kt">A</span><span class="o">](</span><span class="n">size</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">GroupedIterator</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">copyToArray</span><span class="o">[</span><span class="kt">B</span> <span class="k">&gt;:</span> <span class="kt">A</span><span class="o">](</span><span class="n">xs</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">B</span><span class="o">],</span> <span class="n">start</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">len</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">sameElements</span><span class="o">(</span><span class="n">that</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">toTraversable</span><span class="k">:</span> <span class="kt">Traversable</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">toIterator</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">def</span> <span class="n">toStream</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="c1">// ....
</span><span class="o">}</span>
</code></pre></div>
<p>Well, at this point you should be thinking that this violates the principles of
OOP design. When <code class="highlighter-rouge">Iterator</code> comes with operations like <code class="highlighter-rouge">map</code> and <code class="highlighter-rouge">filter</code>,
that are polymorphic and can be overridden, it is no longer just a minimal
protocol for "<em>iterating over things</em>", but a <em>big, fat interface</em>.</p>

<p>You see, there isn't a single possible implementation for <code class="highlighter-rouge">map</code> or for <code class="highlighter-rouge">take</code>
and by providing such operations with a default implementation the
<code class="highlighter-rouge">Iterator</code> is imposing to users how those operations should behave.
Or more specifically:</p>

<ol>
  <li>these operations have lazy behavior, until overridden in subclasses</li>
  <li>assume that the protocol is set in stone</li>
</ol>

<p>But <code class="highlighter-rouge">Iterator</code> is a fine example of an OOP interface because you can add
restrictions to it. Lo and behold how OOP inheritance is supposed to work:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="k">trait</span> <span class="nc">CloseableIterable</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Iterable</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">iterator</span><span class="k">:</span> <span class="kt">CloseableIterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">CloseableIterator</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Iterator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">with</span> <span class="nc">AutoCloseable</span> <span class="o">{</span>
  <span class="cm">/** Closes this resource, relinquishing any underlying resources. */</span>
  <span class="k">def</span> <span class="n">close</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span>
<span class="o">}</span>
</code></pre></div>
<p>BAM, we just invalidated more than 80 operations provided by Scala's <code class="highlighter-rouge">Iterator</code>
and <code class="highlighter-rouge">Iterable</code>. Are you going to override them all?</p>

<p>If you say yes, then you don't know what you're getting yourself into,
plus what are you going to do when Scala 2.13 (or whatever the next version is)
comes with new operators that need to be overridden? Are you going to remember
to do it? It's a hard problem.</p>

<p>I don't mind having implementations of <code class="highlighter-rouge">map</code> and <code class="highlighter-rouge">filter</code> for <code class="highlighter-rouge">Iterator</code>, but
Scala lacks a minimal interface that provides just the raw protocol.
There is value in simplicity. Notice Java's <a href="https://docs.oracle.com/javase/7/docs/api/java/util/Iterator.html">Iterator</a>,
notice C#'s <a href="https://msdn.microsoft.com/en-us/library/system.collections.ienumerator(v=vs.110).aspx">IEnumerator</a>, notice how they don't come with operators attached.
Instead, for C# at least, you can import
<a href="https://github.com/Reactive-Extensions/Rx.NET">Ix.NET</a> in your project,
which gives you a bunch of extension methods you can work with, no strings attached.
Scala could also use <a href="http://typelevel.org/cats/">type-classes</a> which are
much better than extension methods. But instead what currently happens in
Scala's collection library can be seen as <em>inheritance hell</em>.</p>

<p>Not everything needs <code class="highlighter-rouge">map</code> and <code class="highlighter-rouge">flatMap</code> on it.</p>

<p><strong>UPDATE:</strong> there is now an issue for discussing this at
<a href="https://github.com/scala/collection-strawman/issues/17">collection-strawman/issues/#17</a>.</p>

<h2 id="non-problem-early-termination--resource-handling">Non-problem: early termination &amp; resource handling</h2>

<p>The <code class="highlighter-rouge">Iterator</code> interface alone is not enough to expose streams linked
to file handles, network sockets or other resources that need to be disposed
when terminated early.</p>

<p>So rookies (also because of problem 2 above) can end up with unconsumed iterators,
creating possible connection leaks, because it's easy:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="n">iterator</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
</code></pre></div>
<p>However I don't view this as being a problem because:</p>

<ol>
  <li>we don't need to do resource handling everywhere</li>
  <li>as demonstrated in the sample with <code class="highlighter-rouge">CloseableIterator</code> above, you can build
proper resource handling on top of <code class="highlighter-rouge">Iterator</code></li>
  <li>doing I/O by means of an <code class="highlighter-rouge">Iterator</code> is often a bad idea, given
that <code class="highlighter-rouge">Iterator</code> is not capable of asynchronous boundaries, with
I/O operations often being asynchronous</li>
</ol>

<p>Having a <code class="highlighter-rouge">CloseableIterator</code> in the standard library wouldn't be bad though,
however given the very complex inheritance hierarchy and the traversable
grandparents, I'm afraid to wish for it.</p>


    <div class="authorship" itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alexandru Nedelcu">
      Written by <a href="https://alexn.org/about.html" itemprop="url" rel="author">
        Alexandru Nedelcu</a> |
      <a href="https://twitter.com/alexelcu" itemprop="url" rel="author">
        Twitter</a> |
      <a href="https://github.com/alexandru" itemprop="url" rel="author">
        GitHub</a>
    </div>
  </div>

  <footer>
    <div id="other-articles">
      <h2>Recent Articles</h2>

      <ul class="posts">
      	<li>
      	  <time datetime="2018-05-06">
      	    2018-05-06 &raquo;
      	  </time>
      	  <a href="/blog/2018/05/06/bifunctor-io.html" rel="prefetch related">On Bifunctor IO and Java's Checked Exceptions</a>
      	</li>
      	<li>
      	  <time datetime="2018-02-12">
      	    2018-02-12 &raquo;
      	  </time>
      	  <a href="/blog/2018/02/12/in-defense-oofp.html" rel="prefetch related">In Defense of OOFP</a>
      	</li>
      	<li>
      	  <time datetime="2017-11-10">
      	    2017-11-10 &raquo;
      	  </time>
      	  <a href="/blog/2017/11/10/minitest-no-crap-scala-library.html" rel="prefetch related">Minitest: Zero Crap Scala Testing Library</a>
      	</li>
      	<li>
      	  <time datetime="2017-10-15">
      	    2017-10-15 &raquo;
      	  </time>
      	  <a href="/blog/2017/10/15/functional-programming.html" rel="prefetch related">What is Functional Programming?</a>
      	</li>
      	<li>
      	  <time datetime="2017-10-13">
      	    2017-10-13 &raquo;
      	  </time>
      	  <a href="/blog/2017/10/13/scaladays-copenhagen.html" rel="prefetch related">Scala Days 2017 — Monix Task</a>
      	</li>
      	<li>
      	  <time datetime="2017-10-11">
      	    2017-10-11 &raquo;
      	  </time>
      	  <a href="/blog/2017/10/11/javascript-promise-leaks-memory.html" rel="prefetch related">JavaScript's Promise Leaks Memory</a>
      	</li>
      	<li>
      	  <time datetime="2017-08-16">
      	    2017-08-16 &raquo;
      	  </time>
      	  <a href="/blog/2017/08/16/automatic-releases-sbt-travis.html" rel="prefetch related">Automatic Releases to Maven Central with Travis and SBT</a>
      	</li>
      </ul>
    </div>

    <div id="contributions">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'alexnorg';
        var disqus_url = 'http://alexn.org/blog/2017/01/16/iterator.html';

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </footer>
</article>

    </div>
  </div>

  <div id="footer-container">
    <footer>
      <div class="contact">
      	&copy; 2018 Alexandru Nedelcu
      	<br>
      	Some rights reserved (<a href="http://creativecommons.org/licenses/by-nc/3.0/" rel="license">CC BY-NC 3.0</a>)
      </div>

      <div class="rss">
      	<a href="https://twitter.com/alexelcu" target="_blank" title="Follow me on Twitter (@alexelcu)">
      	  <img src="/assets/img/twitter-logo.png" width="60" height="60" alt="Follow me on Twitter (@alexelcu)" />
      	</a>
      </div>
    </footer>
  </div>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-84530423-1', 'auto');
    ga('set', 'anonymizeIp', true);
    ga('send', 'pageview');
  </script>
</body>
</html>
