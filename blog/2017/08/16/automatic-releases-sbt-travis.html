<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width">

  <link rel="canonical" href="https://alexn.org/blog/2017/08/16/automatic-releases-sbt-travis.html">
  <link rel="alternate" href="/atom.xml" title="Atom feed" type="application/atom+xml">

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@alexelcu" />

    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2017-08-16" />
    
    <meta property="article:tag" content="Code" />
    <meta property="article:tag" content="Maven" />
    <meta property="article:tag" content="Open Source" />
    <meta property="article:tag" content="SBT" />
    <meta property="article:tag" content="Scala" />
    <meta property="article:tag" content="Sonatype" />
    <meta property="article:tag" content="Travis" />

    <title>Automatic Releases to Maven Central with Travis and SBT</title>
    <meta name="og:title" content="Automatic Releases to Maven Central with Travis and SBT" />
    <meta name="twitter:title" content="Automatic Releases to Maven Central with Travis and SBT" />

      <meta name="og:image" content="https://alexn.org/assets/img/2017/sbt.png" />
      <meta name="og:image:secure_url" content="https://alexn.org/assets/img/2017/sbt.png" />
      <meta name="twitter:image" content="https://alexn.org/assets/img/2017/sbt.png" />

      <meta name="og:description" content="Enabling automatic releases for your open source Scala project with Travis and SBT." />
      <meta name="twitter:description" content="Enabling automatic releases for your open source Scala project with Travis and SBT." />
      <meta name="description" content="Enabling automatic releases for your open source Scala project with Travis and SBT." />

  <link href="/assets/css/fonts-8b37e535.css" rel="stylesheet" />
  <link href="/assets/css/all-b1326ee4.css" rel="stylesheet" />
  <!--[if lt IE 9]>
  <link href="/assets/css/ie-hacks-0c76b2ed.css" rel="stylesheet" />
  <![endif]-->
</head>
<body>
  <div id="header-container">
    <header>
      <h1 id="title">alexn.org</h1>

      <meta itemprop="lastReviewed" content="2019-01-12"/>
      <div itemprop="reviewedBy" itemscope itemtype="https://schema.org/Person">
        <meta itemprop="name" content="Alexandru Nedelcu">
        <meta itemprop="url" content="https://alexn.org/about.html">
      </div>

      <div class="github-fork-ribbon-wrapper right">
        <div class="github-fork-ribbon">
          <a href="https://github.com/alexandru" itemprop="relatedLink">Fork me on GitHub</a>
        </div>
      </div>

      <nav>
    	  <a href="/">alexn.org</a>
    	  <a class="extra" href="/about.html" itemprop="significantLink">About</a>
      </nav>
    </header>
  </div>

  <div id="main-container">
    <div id="main">
      <article id="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <h1 itemprop="headline">Automatic Releases to Maven Central with Travis and SBT</h1>

    <div id="meta">
      <meta itemscope itemprop="mainEntityOfPage"  itemType="https://schema.org/WebPage" itemid="https://alexn.org/blog/2017/08/16/automatic-releases-sbt-travis.html"/>
      <meta itemprop="datePublished" content="2017-08-16"/>
      <meta itemprop="dateModified" content="2017-08-16"/>

      <time class="post-date" itemprop="dateCreated" datetime="2017-08-16">
        Aug 16, 2017
      </time>

      <span class="twitter-link">
        â€¢ <a href="https://twitter.com/alexelcu">@alexelcu</a>
      </span>

        <div itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
          <meta itemprop="url" content="https://alexn.org/assets/img/2017/sbt.png">
          <meta itemprop="width" content="641">
          <meta itemprop="height" content="277">
        </div>

      <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <meta itemprop="name" content="Alexandru Nedelcu">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
          <meta itemprop="url" content="https://alexn.org/assets/img/alex-big-version-72ppi.jpg">
          <meta itemprop="width" content="585">
          <meta itemprop="height" content="585">
        </div>
      </div>
    </div>
  </header>

  <div id="content" itemprop="articleBody">
    <p>Builds and deployments of new versions and snapshots is a pain.</p>

<p>This article is an explanation to how I automated this process
for <a href="https://monix.io">monix.io</a>, an open source Scala library that's
making use of <a href="http://www.scala-sbt.org/">SBT</a> as the build tool
and <a href="https://travis-ci.org/">travis-ci.org</a> as the continuous
integration.</p>

<p><img src="/assets/img/2017/sbt.png" class="right" width="300" alt="Sbt" /></p>

<p>What this setup does is to trigger a <code class="highlighter-rouge">publish</code> script that
automatically deploys packages on Maven Central:</p>

<ol>
  <li>whenever you tag a release by pushing a version tag in Git, like
<code class="highlighter-rouge">v1.10.0</code></li>
  <li>whenever you push into the <code class="highlighter-rouge">snapshot</code> branch, the result being
hashed versions, e.g. <code class="highlighter-rouge">1.10.0-36fa3d3</code>, where the hash appended
as a suffix is the Git commit hash; these hashed versions are like
snapshot releases, but better because people can rely on them to
remain in Maven Central and thus less volatile</li>
</ol>

<p>After you read this article, you can use the setup of these projects
for inspiration:</p>

<ul>
  <li><a href="https://github.com/monix/shade/">github.com/monix/shade</a></li>
  <li><a href="https://github.com/monix/monix/">github.com/monix/monix</a></li>
</ul>

<p><strong>WARNING:</strong> with this process you'll have to
trust <a href="https://travis-ci.org/">Travis-ci.org</a> with your PGP private
key for signing the published binaries. If that's an acceptable risk
or not, that's up to you. See below.</p>

<h2 id="generating-a-pgp-key-pair">Generating a PGP Key Pair</h2>

<p>For deployments to Sonatype / Maven Central the built packages need to
be signed. If you don't have an existing PGP key, one can be easily
generated.</p>

<p><strong>WARNING:</strong> do not give out your personal PGP private key that you
use to sign emails or for online transactions. Generate a special PGP
key pair just for your project.</p>

<p>I'm currently using a MacOS machine, so for managing PGP
keys I'm using the open source <a href="https://gpgtools.org/">GPG Suite</a>,
coming with a nice GUI interface.</p>

<p>As far as I know GPG comes installed by default on all major Linux
operating systems and for Windows checkout this
<a href="https://www.gnupg.org/download/index.en.html">download page on gnupg.org</a>.</p>

<p>With the GPG command line tools installed you can generate a PGP key pair
like this:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ gpg --gen-key
</code></pre></div>
<p>Steps:</p>

<ul>
  <li>accept the default <code class="highlighter-rouge">RSA</code> for the kind of key</li>
  <li>enter the desired key size, the bigger the better, so enter <code class="highlighter-rouge">4096</code></li>
  <li>for expiration, I preferred a key that doesn't expire, although this might not be wise</li>
  <li>for an email address, enter a valid one</li>
  <li>I recommend encrypting your private key with a generous passphrase
that you then store in 1Password / LastPass ;-)</li>
</ul>

<p>To get the ID of the newly generated key you can do:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ gpg --list-secret-keys --keyid-format LONG
</code></pre></div>
<p>To export this newly generated key, assuming that <code class="highlighter-rouge">2673B174C4071B0E</code>
is the key ID, you'll need both the public key and the private one,
but they can be dumped in the same file:</p>

<div class="highlight"><pre class="highlight plaintext"><code>gpg -a --export 2673B174C4071B0E &gt; my-key.asc
gpg -a --export-secret-keys 2673B174C4071B0E &gt;&gt; my-key.asc
</code></pre></div>
<p>I also keep these in 1Password btw.</p>

<p>To configure SBT to sign your packages with a key living in the
project's repository you'll need a PGP key ring. Such a key ring is
basically a database of multiple PGP keys. You need to have one to
keep in the repository of your project. Normally these keys are kept
in:</p>

<ul>
  <li><code class="highlighter-rouge">$HOME/.gnupg/pubring.gpg</code> for the public keys</li>
  <li><code class="highlighter-rouge">$HOME/.gnupg/secring.gpg</code> for the private keys</li>
</ul>

<p>In the <code class="highlighter-rouge">$PROJECT</code> root we need a custom key ring containing just the
key we need, like this:</p>

<ul>
  <li><code class="highlighter-rouge">$PROJECT/project/.gnupg/pubring.gpg</code> for the public keys</li>
  <li><code class="highlighter-rouge">$PROJECT/project/.gnupg/secring.gpg</code> for the private keys</li>
</ul>

<p>These files are going to be encrypted, to provide minimal protection.
To generate this ring in your project, go to you're project's root
directory and then:</p>

<div class="highlight"><pre class="highlight plaintext"><code>gpg --no-default-keyring \
  --primary-keyring `pwd`/project/.gnupg/pubring.gpg \
  --secret-keyring `pwd`/project/.gnupg/secring.gpg \
  --keyring `pwd`/project/.gnupg/pubring.gpg \
  --fingerprint \
  --import path/to/my-key.asc
</code></pre></div>
<p>The <code class="highlighter-rouge">my-key.asc</code> file is the one that you've created in the previous step.</p>

<p>After you create these files, make sure to delete any junk from
<code class="highlighter-rouge">$PROJECT/project/.gnupg</code>, so verify the newly created files with
<code class="highlighter-rouge">git status</code>.</p>

<p>NOTE: check the newly created files, because the <code class="highlighter-rouge">gpg</code> command line
tools might generate junk. We only want those 2 files (<code class="highlighter-rouge">pubring.gpg</code>
and <code class="highlighter-rouge">secring.gpg</code>), so check your project directory with <code class="highlighter-rouge">git status</code>
and delete anything extra.</p>

<h2 id="configuring-sbt">Configuring SBT</h2>

<p>Curently in <a href="https://monix.io">monix.io</a> I'm using the following plugins:</p>

<ul>
  <li><a href="https://github.com/sbt/sbt-pgp">sbt-pgp</a> for signing packages with PGP</li>
  <li><a href="https://github.com/sbt/sbt-git">sbt-git</a> for making use of Git from
SBT, relevant here if you want to do Git-enabled version hashes</li>
  <li><a href="https://github.com/xerial/sbt-sonatype">sbt-sonatype</a> for automatically
publishing artifacts to Maven Central</li>
</ul>

<p>For PGP the configuration is as follows:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="n">useGpg</span> <span class="o">:=</span> <span class="kc">false</span>
<span class="n">usePgpKeyHex</span><span class="o">(</span><span class="s">"2673B174C4071B0E"</span><span class="o">)</span>
<span class="n">pgpPublicRing</span> <span class="o">:=</span> <span class="n">baseDirectory</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="s">"project"</span> <span class="o">/</span> <span class="s">".gnupg"</span> <span class="o">/</span> <span class="s">"pubring.gpg"</span>
<span class="n">pgpSecretRing</span> <span class="o">:=</span> <span class="n">baseDirectory</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="s">"project"</span> <span class="o">/</span> <span class="s">".gnupg"</span> <span class="o">/</span> <span class="s">"secring.gpg"</span>
<span class="n">pgpPassphrase</span> <span class="o">:=</span> <span class="n">sys</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">"PGP_PASS"</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span>
</code></pre></div>
<p>Explanation:</p>

<ul>
  <li><code class="highlighter-rouge">useGpg := false</code> says that we do not want to use the GPG tools
installed on your computer, but rather the implementation that
<code class="highlighter-rouge">sbt-pgp</code> ships with; in my experience this is a must, otherwise
depending on the GPG tools you have, you won't be able to make it
use a different pgp ring</li>
  <li><code class="highlighter-rouge">usePgpKeyHex</code> forces a certain key to be used for signing by
specifying its key</li>
  <li><code class="highlighter-rouge">pgpPublicRing</code> and <code class="highlighter-rouge">pgpPublicRing</code> specify the path to a GPG ring
that contains the key you want, instead of the default one which is
usually <code class="highlighter-rouge">$HOME/.gnupg/pubring.gpg</code> and <code class="highlighter-rouge">$HOME/.gnupg/secring.gpg</code></li>
  <li><code class="highlighter-rouge">pgpPassphrase</code> is a GPG passphrase for the used key, that's taken
from the env variable named <code class="highlighter-rouge">PGP_PASS</code>; Travis has the ability to
set such env variables to be available in your build</li>
</ul>

<p>For publishing to Sonatype, we'll need these settings:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="n">sonatypeProfileName</span> <span class="o">:=</span> <span class="n">organization</span><span class="o">.</span><span class="n">value</span>

<span class="n">credentials</span> <span class="o">+=</span> <span class="nc">Credentials</span><span class="o">(</span>
  <span class="s">"Sonatype Nexus Repository Manager"</span><span class="o">,</span>
  <span class="s">"oss.sonatype.org"</span><span class="o">,</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">"SONATYPE_USER"</span><span class="o">,</span> <span class="s">""</span><span class="o">),</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">"SONATYPE_PASS"</span><span class="o">,</span> <span class="s">""</span><span class="o">)</span>
<span class="o">)</span>

<span class="n">isSnapshot</span> <span class="o">:=</span> <span class="n">version</span><span class="o">.</span><span class="n">value</span> <span class="n">endsWith</span> <span class="s">"SNAPSHOT"</span>

<span class="n">publishTo</span> <span class="o">:=</span> <span class="nc">Some</span><span class="o">(</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">isSnapshot</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
    <span class="nc">Opts</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">sonatypeSnapshots</span>
  <span class="k">else</span>
    <span class="nc">Opts</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">sonatypeStaging</span>
<span class="o">)</span>
</code></pre></div>
<p>In addition to these options, for Sonatype we also need the required
artifact info (e.g. license, homepage, authors). Here's what I have
for Shade, adjust accordingly:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="n">licenses</span> <span class="o">:=</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">"MIT"</span> <span class="o">-&gt;</span> <span class="n">url</span><span class="o">(</span><span class="s">"https://opensource.org/licenses/MIT"</span><span class="o">))</span>
<span class="n">homepage</span> <span class="o">:=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">url</span><span class="o">(</span><span class="s">"https://github.com/monix/shade"</span><span class="o">))</span>

<span class="n">scmInfo</span> <span class="o">:=</span> <span class="nc">Some</span><span class="o">(</span>
  <span class="nc">ScmInfo</span><span class="o">(</span>
    <span class="n">url</span><span class="o">(</span><span class="s">"https://github.com/monix/shade"</span><span class="o">),</span>
    <span class="s">"scm:git@github.com:monix/shade.git"</span>
  <span class="o">))</span>

<span class="n">developers</span> <span class="o">:=</span> <span class="nc">List</span><span class="o">(</span>
  <span class="nc">Developer</span><span class="o">(</span>
    <span class="n">id</span><span class="o">=</span><span class="s">"alexelcu"</span><span class="o">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s">"Alexandru Nedelcu"</span><span class="o">,</span>
    <span class="n">email</span><span class="o">=</span><span class="s">"noreply@alexn.org"</span><span class="o">,</span>
    <span class="n">url</span><span class="k">=</span><span class="n">url</span><span class="o">(</span><span class="s">"https://alexn.org"</span><span class="o">)</span>
  <span class="o">))</span>
</code></pre></div>
<p>TIP, to find out the ID of a license type, see this cool list:
<a href="https://spdx.org/licenses/">spdx.org/licenses/</a>.</p>

<p>You'll need those two environment variables set in Travis's settings,
more details below.</p>

<p>And then to enable Git versioning for snapshots (e.g. <code class="highlighter-rouge">3.0.0-9d94d3d</code>)
you can do:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="n">enablePlugins</span><span class="o">(</span><span class="nc">GitVersioning</span><span class="o">)</span>

<span class="cm">/* The BaseVersion setting represents the in-development (upcoming) version,
 * as an alternative to SNAPSHOTS.
 */</span>
<span class="n">git</span><span class="o">.</span><span class="n">baseVersion</span> <span class="o">:=</span> <span class="s">"3.0.0"</span>

<span class="k">val</span> <span class="nc">ReleaseTag</span> <span class="k">=</span> <span class="s">"""^v([\d\.]+)$"""</span><span class="o">.</span><span class="n">r</span>
<span class="n">git</span><span class="o">.</span><span class="n">gitTagToVersionNumber</span> <span class="o">:=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">ReleaseTag</span><span class="o">(</span><span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">v</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
<span class="o">}</span>

<span class="n">git</span><span class="o">.</span><span class="n">formattedShaVersion</span> <span class="o">:=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">suffix</span> <span class="k">=</span> <span class="n">git</span><span class="o">.</span><span class="n">makeUncommittedSignifierSuffix</span><span class="o">(</span><span class="n">git</span><span class="o">.</span><span class="n">gitUncommittedChanges</span><span class="o">.</span><span class="n">value</span><span class="o">,</span> <span class="n">git</span><span class="o">.</span><span class="n">uncommittedSignifier</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>

  <span class="n">git</span><span class="o">.</span><span class="n">gitHeadCommit</span><span class="o">.</span><span class="n">value</span> <span class="n">map</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">7</span><span class="o">)</span> <span class="o">}</span> <span class="n">map</span> <span class="o">{</span> <span class="n">sha</span> <span class="k">=&gt;</span>
    <span class="n">git</span><span class="o">.</span><span class="n">baseVersion</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span> <span class="n">sha</span> <span class="o">+</span> <span class="n">suffix</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Now test your setup with this command:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ PGP_PASS="xxxxxx" sbt publishLocalSigned
</code></pre></div>
<p>Replace <code class="highlighter-rouge">xxxxxx</code> with your passphrase. If this command works, then we
are good thus far.</p>

<h2 id="configuring-travis">Configuring Travis</h2>

<p>In <code class="highlighter-rouge">build.sbt</code> I configured these 2 commands:</p>

<div class="highlight"><pre class="highlight scala"><code><span class="n">addCommandAlias</span><span class="o">(</span><span class="s">"ci-all"</span><span class="o">,</span>  <span class="s">";+clean ;+compile ;+test ;+package"</span><span class="o">)</span>
<span class="n">addCommandAlias</span><span class="o">(</span><span class="s">"release"</span><span class="o">,</span> <span class="s">";+publishSigned ;sonatypeReleaseAll"</span><span class="o">)</span>
</code></pre></div>
<p>Then the <code class="highlighter-rouge">.travis.yml</code> file has something like this:</p>

<div class="highlight"><pre class="highlight yaml"><code><span class="na">language</span><span class="pi">:</span> <span class="s">scala</span>
<span class="na">sudo</span><span class="pi">:</span> <span class="s">required</span>
<span class="na">dist</span><span class="pi">:</span> <span class="s">trusty</span>
<span class="na">group</span><span class="pi">:</span> <span class="s">edge</span>

<span class="na">matrix</span><span class="pi">:</span>
  <span class="na">include</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">jdk</span><span class="pi">:</span> <span class="s">oraclejdk8</span>
      <span class="na">scala</span><span class="pi">:</span> <span class="s">2.12.3</span>
      <span class="na">env</span><span class="pi">:</span> <span class="s">COMMAND=ci-all PUBLISH=true</span>

<span class="na">script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">sbt -J-Xmx6144m ++$TRAVIS_SCALA_VERSION $COMMAND</span>

<span class="na">after_success</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">./project/publish</span>
</code></pre></div>
<p>And then the <code class="highlighter-rouge">project/publish</code> script, which I've built with Ruby
(since I don't know Bash well :)):</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
  <span class="nb">abort</span><span class="p">(</span><span class="s2">"Error encountered, aborting"</span><span class="p">)</span> <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s2">"CI=</span><span class="si">#{</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'CI'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">puts</span> <span class="s2">"TRAVIS_BRANCH=</span><span class="si">#{</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'TRAVIS_BRANCH'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">puts</span> <span class="s2">"TRAVIS_PULL_REQUEST=</span><span class="si">#{</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'TRAVIS_PULL_REQUEST'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">puts</span> <span class="s2">"PUBLISH=</span><span class="si">#{</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'PUBLISH'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">puts</span>

<span class="k">unless</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'CI'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'true'</span>
  <span class="nb">abort</span><span class="p">(</span><span class="s2">"ERROR: Not running on top of Travis, aborting!"</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">unless</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'PUBLISH'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'true'</span>
  <span class="nb">puts</span> <span class="s2">"Publish is disabled"</span>
  <span class="nb">exit</span>
<span class="k">end</span>

<span class="n">branch</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'TRAVIS_BRANCH'</span><span class="p">]</span>
<span class="n">version</span> <span class="o">=</span> <span class="kp">nil</span>

<span class="k">unless</span> <span class="n">branch</span> <span class="o">=~</span> <span class="sr">/^v(\d+\.\d+\.\d+)$/</span> <span class="o">||</span>
  <span class="p">(</span><span class="n">branch</span> <span class="o">==</span> <span class="s2">"snapshot"</span> <span class="o">&amp;&amp;</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'TRAVIS_PULL_REQUEST'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'false'</span><span class="p">)</span>

  <span class="nb">puts</span> <span class="s2">"Only triggering deployment on the `snapshot` branch, or for version tags "</span> <span class="o">+</span>
       <span class="s2">"and not for pull requests or other branches, exiting!"</span>
  <span class="nb">exit</span> <span class="mi">0</span>
<span class="k">else</span>
  <span class="n">version</span> <span class="o">=</span> <span class="vg">$1</span>
  <span class="nb">puts</span> <span class="s2">"Version branch detected: </span><span class="si">#{</span><span class="n">version</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">version</span>
<span class="k">end</span>

<span class="c1"># Forcing a change to the root directory, if not there already</span>
<span class="no">Dir</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">absolute_path</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">),</span> <span class="s2">".."</span><span class="p">)))</span>

<span class="c1"># Go, go, go</span>
<span class="nb">exec</span><span class="p">(</span><span class="s2">"sbt release"</span><span class="p">)</span>
</code></pre></div>
<p>Give execution permissions to this script:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ chmod +x ./project/publish
</code></pre></div>
<p>Remember to push your changes:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ git add .
$ git commit -am 'Build changes for automatic releases'
$ git push
</code></pre></div>
<h3 id="setting-environment-variables">Setting environment variables</h3>

<p>As a final step we need to set the following environment variables in Travis:</p>

<ul>
  <li><code class="highlighter-rouge">PGP_PASS</code>: the passphrase we used to encrypt our private PGP key</li>
  <li><code class="highlighter-rouge">SONATYPE_USER</code>: a user to login to Sonatype, used by SBT to publish and deploy releases on Sonatype</li>
  <li><code class="highlighter-rouge">SONATYPE_PASS</code>: a password to login to Sonatype, used by SBT to publish and deploy releases on Sonatype</li>
</ul>

<p>See the article on
<a href="https://docs.travis-ci.com/user/environment-variables/">adding environment variables to Travis</a>.</p>

<p>NOTE: to get a <code class="highlighter-rouge">SONATYPE_USER</code> and a <code class="highlighter-rouge">SONATYPE_PASS</code> go to the
<a href="https://oss.sonatype.org/#profile;User%20Token">User Profile on Sonatype</a> page
and access the "<em>User Token</em>", or generate a new one.</p>

<p>Here's a screenshot of how my setup currently looks like:</p>

<p><img src="/assets/img/2017/travis-env-vars.png" class="max" width="2032" height="734" alt="Travis env vars" /></p>

<h3 id="alternative-env-with-travis-encryption">Alternative Env with Travis Encryption</h3>

<p>As an alternative to setting those environment variables in Travis's
UI, you can use Travis's mechanism for encrypting stuff to set these
values in <code class="highlighter-rouge">.travis.yml</code>. See
the <a href="https://docs.travis-ci.com/user/encryption-keys">Encryption Keys</a>
document.</p>

<p>First install the <code class="highlighter-rouge">travis</code> command line tool:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ gem install travis
</code></pre></div>
<p>And then do the following, replacing <code class="highlighter-rouge">xxxxx</code> with your key:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ travis encrypt 'PGP_PASS=xxxxx' --add

$ travis encrypt 'SONATYPE_USER=xxxxx' --add

$ travis encrypt 'SONATYPE_PASS=xxxxx' --add
</code></pre></div>
<p>NOTE: if your env values have special chars, they might need to be
escaped for Bash to not trigger any errors. See document above.</p>

<p>These commands will modify your <code class="highlighter-rouge">.travis.yml</code> file, adding a section
that resembles the following:</p>

<div class="highlight"><pre class="highlight plaintext"><code>env:
  global:
  - secure: GRdfKNrJn/zqjaDWE+16HCfuCSf/wsDpL...
  - secure: SPSIblLKFVns7pVY1x3SEs4/16htY5HUz...
  - secure: YVx2BSSsqF7LdYTwinf6o8nqJiYL9FeFA...
</code></pre></div>
<p>Now this can be committed in your repository and Travis will take care
of decrypting those values.</p>

<h2 id="publishing">Publishing</h2>

<p>For publishing hashed snapshot versions, we need a <code class="highlighter-rouge">snapshot</code> branch,
as that's what the script above looks for.</p>

<p>So create this branch by forking <code class="highlighter-rouge">master</code> and pushing it, like so:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ git checkout master

$ git checkout -b snapshot
$ git push --set-upstream origin snapshot
</code></pre></div>
<p>If everything goes well, we should have a new hashed version published,
but watch the output of Travis for any problems.</p>

<h2 id="extra-resources">Extra Resources</h2>

<p>I've written this document while preparing the Shade project for
automatic deployments. So here's for inspiration:</p>

<ul>
  <li><a href="https://github.com/monix/shade/compare/1c373f8714e92b48a8bb2337158f61e5650d260a...d712897f122642835cbcd32d159e917c59e7685c">commits in monix/shade</a></li>
  <li><a href="https://travis-ci.org/monix/shade/jobs/265215531">snapshot release sample</a>
(that published <code class="highlighter-rouge">1.10.0-d712897</code> on Maven Central)</li>
  <li><a href="https://travis-ci.org/monix/shade/jobs/265221087">release of v1.10.0</a>
(that published the final <code class="highlighter-rouge">1.10.0</code> on Maven Central)</li>
</ul>

<h2 id="in-closing">In Closing</h2>

<p>So that's about it. Pretty painful if you ask me, but hopefully we
don't have to do this too often.</p>

<p>I've written this article for myself actually, because I keep
forgetting what I did the first time.</p>


    <div class="authorship" itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alexandru Nedelcu">
      Written by <a href="https://alexn.org/about.html" itemprop="url" rel="author">
        Alexandru Nedelcu</a> |
      <a href="https://twitter.com/alexelcu" itemprop="url" rel="author">
        Twitter</a> |
      <a href="https://github.com/alexandru" itemprop="url" rel="author">
        GitHub</a>
    </div>
  </div>

  <footer>
    <div id="other-articles">
      <h2>Recent Articles</h2>

      <ul class="posts">
      	<li>
      	  <time datetime="2018-05-06">
      	    2018-05-06 &raquo;
      	  </time>
      	  <a href="/blog/2018/05/06/bifunctor-io.html" rel="prefetch related">On Bifunctor IO and Java's Checked Exceptions</a>
      	</li>
      	<li>
      	  <time datetime="2018-02-12">
      	    2018-02-12 &raquo;
      	  </time>
      	  <a href="/blog/2018/02/12/in-defense-oofp.html" rel="prefetch related">In Defense of OOFP</a>
      	</li>
      	<li>
      	  <time datetime="2017-11-10">
      	    2017-11-10 &raquo;
      	  </time>
      	  <a href="/blog/2017/11/10/minitest-no-crap-scala-library.html" rel="prefetch related">Minitest: Zero Crap Scala Testing Library</a>
      	</li>
      	<li>
      	  <time datetime="2017-10-15">
      	    2017-10-15 &raquo;
      	  </time>
      	  <a href="/blog/2017/10/15/functional-programming.html" rel="prefetch related">What is Functional Programming?</a>
      	</li>
      	<li>
      	  <time datetime="2017-10-13">
      	    2017-10-13 &raquo;
      	  </time>
      	  <a href="/blog/2017/10/13/scaladays-copenhagen.html" rel="prefetch related">Scala Days 2017 â€” Monix Task</a>
      	</li>
      	<li>
      	  <time datetime="2017-10-11">
      	    2017-10-11 &raquo;
      	  </time>
      	  <a href="/blog/2017/10/11/javascript-promise-leaks-memory.html" rel="prefetch related">JavaScript's Promise Leaks Memory</a>
      	</li>
      	<li>
      	  <time datetime="2017-03-15">
      	    2017-03-15 &raquo;
      	  </time>
      	  <a href="/blog/2017/03/15/fp-inception.html" rel="prefetch related">Functional Programming Inception - Bucharest FP</a>
      	</li>
      </ul>
    </div>

    <div id="contributions">
      <script data-isso="/comments/alexn/"
              data-isso-css="true"
              data-isso-lang="en"
              data-isso-reply-to-self="true"
              data-isso-require-author="true"
              data-isso-require-email="false"
              data-isso-reply-notifications="true"
              data-isso-max-comments-top="10"
              data-isso-max-comments-nested="5"
              data-isso-reveal-on-click="5"
              data-isso-gravatar="true"
              data-isso-avatar="false"
              data-isso-vote="true"
              data-vote-levels=""
              src="https://alexn.org/comments/alexn/js/embed.min.js"></script>
      <section id="isso-thread" data-title="{{ page.title }}">
      </section>
    </div>
  </footer>
</article>

    </div>
  </div>

  <div id="footer-container">
    <footer>
      <div class="rss">
      	<a href="https://twitter.com/alexelcu" target="_blank" title="Follow me on Twitter (@alexelcu)">
      	  <img src="/assets/img/twitter-logo.png" width="60" height="60" alt="Follow me on Twitter (@alexelcu)" />
      	</a>
      </div>

      <div class="links">
        <a href="/docs/privacy-policy.html">Privacy policy</a> |
        <a href="https://twitter.com/alexelcu" target="_blank">Twitter</a> |
        <a href="https://github.com/alexandru" target="_blank">GitHub</a>
      </div>

      <div class="contact">
      	&copy; 2019 Alexandru Nedelcu
      	<br>
      	Some rights reserved (<a href="http://creativecommons.org/licenses/by-nc/3.0/" rel="license">CC BY-NC 3.0</a>)
      </div>
    </footer>
  </div>

  <!-- Analytics -->
  <script>
    function loadAnalytics() {
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-84530423-1', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');
    }
    // Checks DO-NOT-TRACK status
    if (window.doNotTrack || navigator.doNotTrack || navigator.msDoNotTrack || 'msTrackingProtectionEnabled' in window.external) {
      var dnd = window.doNotTrack == "1" || navigator.doNotTrack == "yes" || navigator.doNotTrack == "1" || navigator.msDoNotTrack == "1" || window.external.msTrackingProtectionEnabled();
      if (!dnd) loadAnalytics();
    } else {
      loadAnalytics();
    }
  </script>
  <!-- End Analytics -->  
</body>
</html>
